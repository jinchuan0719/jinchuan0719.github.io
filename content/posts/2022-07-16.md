---
title: "Ansible适配KylinOS操作系统改造"
date: 2022-07-16T21:33:08+08:00
draft: true
#tags: "Ansible KylinOS"
---

## 背景说明
[Ansible](https://docs.ansible.com/ansible/devel/getting_started/index.html)是一款常用的服务器配置管理软件，由RedHat.Inc主导开发，支持多款主流操作系统，在大数据、云计算和各类IT基础设施领域都有广泛的应用。 

近期国内信创事业发展迅速，国产优质开源操作系统发展前景看涨；再加上RedHat确认CentOS 8转向CentOS Stream后，给国内不少CentOS用户吃下了转投国产操作系统的定心丸。近期在适配国产麒麟操作系统时，发现原来在CentOS上跑得很顺溜的Ansible Playbook脚本出现了问题——不是说KylinOS内核是兼容CentOS的么？初步分析问题主要出现操作系统的版本判断上，报错信息如下：

```

```

根据报错找了些参考说明，大多是建议更改操作系统的`/etc/os-release`文件，将VERSION_ID该成7或8来临时解决，但这明显不是个长久和业务能接受的方案。
```

```


## 原因分析
Ansible操作前会获取远端服务器系统的版本，判断其是否在支持   。版本相关的信息主要会从/etc/os-release中获取，相应的判断逻辑同样在_distro.py中可以找到

/usr/share/python2.7/xxx/lib/ansible/module_utils/distro/_distro.py

```python
   def version(self, pretty=False, best=False):
        # type: (bool, bool) -> str
        """
        Return the version of the OS distribution, as a string.
        For details, see :func:`distro.version`.
        """
        versions = [
            self.os_release_attr("version_id"),
            self.lsb_release_attr("release"),
            self.distro_release_attr("version_id"),
            self._parse_distro_release_content(self.os_release_attr("pretty_name")).get(
                "version_id", ""
            ),
            self._parse_distro_release_content(
                self.lsb_release_attr("description")
            ).get("version_id", ""),
            self.uname_attr("release"),
        ]
        version = ""
        if best:
            # This algorithm uses the last version in priority order that has
            # the best precision. If the versions are not in conflict, that
            # does not matter; otherwise, using the last one instead of the
            # first one might be considered a surprise.
            for v in versions:
                if v.count(".") > version.count(".") or version == "":
                    version = v
        else:
            for v in versions:
                if v != "":
                    version = v
                    break
        if pretty and version and self.codename():
            version = "{0} ({1})".format(version, self.codename())
        return 
```

linux_distribution(full_distribution_name=True) 返回的值在后面使用时，会进行判断，而出现数字类型转换的异常

麒麟的/etc/os-release为定制后的版本，其VERSION_ID 不符合相应规范。导致在后面判断Version时出错


## 解决思路
在 version 方法中添加对KylinOS的处理逻辑即可



## 总结

KylinOS采用的内核是基于RedHat/CentOS特定版本，所以在系统层面上大部分软件都是兼容的，且目前发展出银河麒麟v10（对标CentOS 8）以及中标麒麟v7（对标CentOS 7）等多个版本，但不可避免仍有很多不兼容的软件或场景存在，就像上面提到的Ansible。

国内的开源软件商在做适配或者定制化的时候，可以多思考下，如何改造能最有利于软件的推广和满足兼容性需求。Ansible的这个案例理论上只需要遵循开源业界的做法和规约，将操作系统的VERSION_ID指定成一个正常的版本号就能避免出现这类兼容性异常，如将现在的v7Update6变更成7.6即可。
